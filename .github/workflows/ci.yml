
name: CI (Manual)

on:
  workflow_dispatch:
    inputs:
      run_tests:
        description: "Run tests?"
        type: boolean
        default: true
        required: true
      maven_profile:
        description: "Optional Maven profile (e.g., prod, dev)"
        type: string
        required: false
        default: ""

permissions:
  contents: read

concurrency:
  group: ci-manual-${{ github.run_id }}
  cancel-in-progress: true

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17 (Temurin) + Maven cache
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Build & test (produces JUnit + JaCoCo)
        if: ${{ inputs.run_tests }}
        run: |
          mvn -B clean verify \
            ${{ inputs.maven_profile && format('-P {0}', inputs.maven_profile) || '' }}

      - name: Build without tests
        if: ${{ !inputs.run_tests }}
        run: |
          mvn -B clean package -DskipTests \
            ${{ inputs.maven_profile && format('-P {0}', inputs.maven_profile) || '' }}

      - name: Package JAR (skip tests to speed packaging)
        # Safe to run regardless; if tests already ran, it just repackages quickly
        run: |
          mvn -B -DskipTests package \
            ${{ inputs.maven_profile && format('-P {0}', inputs.maven_profile) || '' }}

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: demo-app
          path: target/*.jar

      # Upload test reports only when tests ran
      - name: Upload test reports (JUnit)
        if: ${{ always() && inputs.run_tests }}
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports/**

      # Upload coverage report only when tests ran
      - name: Upload coverage (JaCoCo HTML/XML)
        if: ${{ always() && inputs.run_tests }}
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: |
            target/site/jacoco/**
            target/jacoco.exec
